<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus-Care | Student Support Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --soft-blue: #e0f2fe;
            --primary-blue: #0ea5e9;
            --dark-blue: #0369a1;
            --sos-red: #ef4444;
            --text-gray: #475569;
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--soft-blue); color: var(--text-gray); scroll-behavior: smooth; }

        /* --- NAVIGATION --- */
        nav { background: var(--white); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .logo { font-weight: 700; font-size: 1.4rem; color: var(--primary-blue); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; align-items: center; gap: 20px; }
        .nav-links a { text-decoration: none; color: var(--text-gray); font-weight: 600; font-size: 0.9rem; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary-blue); }

        .sos-btn { background: var(--sos-red); color: white; padding: 8px 20px; border-radius: 50px; font-weight: 800; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; animation: blink 1.5s infinite; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        @keyframes blink { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* --- HERO & SELECTION --- */
        .hero { padding: 60px 5%; text-align: center; }
        .institute-select { padding: 15px 25px; width: 100%; max-width: 500px; border-radius: 12px; border: 2px solid var(--primary-blue); font-size: 1rem; outline: none; margin-bottom: 20px; }

        /* --- SECTIONS --- */
        section { padding: 80px 10%; margin: 20px 5%; background: var(--white); border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        h2 { margin-bottom: 30px; color: var(--dark-blue); font-size: 1.8rem; border-left: 5px solid var(--primary-blue); padding-left: 15px; }

        /* --- COMPLAINT FORM --- */
        .form-group { margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 5px; }
        .submit-btn { background: var(--primary-blue); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; }

    </style>
</head>
<body>

    <nav>
        <div class="logo">Campus-Care</div>
        <div class="nav-links">
            <a href="#complaint">Complaint</a>
            <a href="#heatmap">Heatmap</a>
            <button class="sos-btn" onclick="handleSOS()"><i class="fas fa-phone-alt"></i> SOS</button>
        </div>
    </nav>

    <header class="hero">
        <h1>Welcome to Student Support</h1>
        <p>Your safety and feedback drive campus improvement.</p>
    </header>

    <!-- COMPLAINT SECTION -->
    <section id="complaint">
        <h2>Lodge Anonymous Complaint</h2>
        <div class="form-group">
            <label>Category</label>
            <select id="category-select">
                <option>Infrastructure (Water/Electricity)</option>
                <option>Women's Safety / Harassment</option>
                <option>Academic Quality</option>
                <option>Hostel Facilities</option>
            </select>
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="desc-text" placeholder="Tell us what happened..."></textarea>
        </div>
        <button class="submit-btn" onclick="submitComplaint()">Submit Report</button>
    </section>

    <!-- HEATMAP SECTION -->
    <section id="heatmap">
        <h2>Campus Complaint Heatmap</h2>
        <p style="margin-bottom: 15px;">Visualizing high-complaint zones.</p>
        
        <div class="heatmap-container" style="width: 100%; height: 500px; border-radius: 15px; overflow: hidden; border: 1px solid #ddd;">
            <!-- Note: src points to our Backend Route -->
            <iframe 
                id="map-frame"
                src="http://localhost:3000/map"
                width="100%" 
                height="100%" 
                frameborder="0">
            </iframe>
        </div>
    </section>

    <script>
        let currentLat = null;
        let currentLng = null;

        // 1. Get Location on Load
        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    console.log("üìç User Location Locked:", currentLat, currentLng);
                }, function(error) {
                    alert("‚ö†Ô∏è Please enable GPS to use Campus-Care.");
                });
            }
        };

        // 2. Submit Logic (Fixed)
        async function submitComplaint() {
            const category = document.getElementById('category-select').value;
            const description = document.getElementById('desc-text').value;

            if (!description) { alert("Please provide a description."); return; }
            if (!currentLat || !currentLng) { alert("Waiting for GPS... Please allow location access."); return; }

            try {
                // Connecting to Node.js Backend
                const response = await fetch('http://localhost:3000/report_complaint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: currentLat,
                        lng: currentLng,
                        category: category,
                        description: description
                    })
                });

                const result = await response.json();

                if (result.status === "success") {
                    alert("‚úÖ Success! Your report has been logged.");
                    document.getElementById('desc-text').value = ""; // Clear form
                    // Refresh the map iframe to show new point
                    document.getElementById('map-frame').src = document.getElementById('map-frame').src;
                }
            } catch (error) {
                console.error("Error submitting complaint:", error);
                alert("Server error. Is the backend running?");
            }
        }

        function handleSOS() {
            if (confirm("üö® TRIGGER SOS ALERT?")) {
                alert("SOS Sent to Security!");
            }
        }
    </script>
</body>
</html>
